<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TWH Intelligence Platform</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 40px rgba(0,0,0,0.12);
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;

    const API_BASE = '';

    function App() {
      const [page, setPage] = useState('dashboard');
      const [loading, setLoading] = useState(false);

      return (
        <div className="min-h-screen">
          <nav className="gradient-bg text-white shadow-lg">
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-2">
                  <span className="text-2xl">üè•</span>
                  <h1 className="text-xl font-bold">TWH Intelligence Platform</h1>
                </div>
                <div className="flex space-x-4">
                  {['dashboard', 'articles', 'sources', 'entities', 'docs'].map(p => (
                    <button
                      key={p}
                      onClick={() => setPage(p)}
                      className={`px-4 py-2 rounded-lg transition ${
                        page === p ? 'bg-white/20' : 'hover:bg-white/10'
                      }`}
                    >
                      {p.charAt(0).toUpperCase() + p.slice(1)}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </nav>

          <main className="max-w-7xl mx-auto px-4 py-8">
            {page === 'dashboard' && <Dashboard />}
            {page === 'articles' && <Articles />}
            {page === 'sources' && <Sources />}
            {page === 'entities' && <Entities />}
            {page === 'docs' && <Docs />}
          </main>
        </div>
      );
    }

    function Dashboard() {
      const [data, setData] = useState(null);
      const [triggering, setTriggering] = useState(false);

      useEffect(() => {
        fetch(`${API_BASE}/api/dashboard`)
          .then(r => r.json())
          .then(setData)
          .catch(console.error);
      }, []);

      const triggerWorkflow = async () => {
        setTriggering(true);
        try {
          await fetch(`${API_BASE}/api/trigger`, { method: 'POST' });
          alert('Workflow triggered! Check back in a few minutes for new articles.');
        } catch (e) {
          alert('Failed to trigger workflow');
        }
        setTriggering(false);
      };

      if (!data) return <div className="text-center py-12">Loading...</div>;

      const stats = [
        { label: 'Articles', value: data.stats.total_articles, icon: 'üì∞', color: 'blue' },
        { label: 'Organizations', value: data.stats.total_organizations, icon: 'üè¢', color: 'green' },
        { label: 'Technologies', value: data.stats.total_technologies, icon: 'üíª', color: 'purple' },
        { label: 'People', value: data.stats.total_people, icon: 'üë§', color: 'orange' },
        { label: 'Summaries', value: data.stats.total_summaries, icon: 'üìù', color: 'pink' },
        { label: 'Active Sources', value: data.stats.active_sources, icon: 'üì°', color: 'cyan' },
      ];

      return (
        <div>
          <div className="flex justify-between items-center mb-8">
            <h2 className="text-2xl font-bold text-gray-800">Dashboard</h2>
            <button
              onClick={triggerWorkflow}
              disabled={triggering}
              className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-6 py-2 rounded-lg hover:opacity-90 disabled:opacity-50 flex items-center space-x-2"
            >
              <span>{triggering ? '‚è≥' : 'üöÄ'}</span>
              <span>{triggering ? 'Running...' : 'Run Agent Now'}</span>
            </button>
          </div>

          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
            {stats.map(stat => (
              <div key={stat.label} className="bg-white rounded-xl shadow-sm p-4 card-hover transition">
                <div className="text-2xl mb-2">{stat.icon}</div>
                <div className="text-3xl font-bold text-gray-800">{stat.value}</div>
                <div className="text-sm text-gray-500">{stat.label}</div>
              </div>
            ))}
          </div>

          <h3 className="text-xl font-semibold mb-4 text-gray-800">Recent Articles</h3>
          <div className="space-y-4">
            {data.recentArticles.map(article => (
              <ArticleCard key={article.id} article={article} />
            ))}
          </div>
        </div>
      );
    }

    function ArticleCard({ article }) {
      const [expanded, setExpanded] = useState(false);

      return (
        <div className="bg-white rounded-xl shadow-sm p-6 card-hover transition">
          <div className="flex justify-between items-start">
            <div className="flex-1">
              <a 
                href={article.url} 
                target="_blank" 
                rel="noopener noreferrer"
                className="text-lg font-semibold text-gray-800 hover:text-purple-600 transition"
              >
                {article.title}
              </a>
              <div className="flex items-center space-x-3 mt-2 text-sm text-gray-500">
                {article.source_name && <span>üì° {article.source_name}</span>}
                {article.published_date && (
                  <span>üìÖ {new Date(article.published_date).toLocaleDateString()}</span>
                )}
              </div>
            </div>
            {article.relevance_score && (
              <div className={`px-3 py-1 rounded-full text-sm font-medium ${
                article.relevance_score >= 8 ? 'bg-green-100 text-green-800' :
                article.relevance_score >= 5 ? 'bg-yellow-100 text-yellow-800' :
                'bg-gray-100 text-gray-800'
              }`}>
                {article.relevance_score}/10
              </div>
            )}
          </div>

          {article.topic_tags && article.topic_tags.length > 0 && (
            <div className="flex flex-wrap gap-2 mt-3">
              {article.topic_tags.map(tag => (
                <span key={tag} className="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs">
                  {tag}
                </span>
              ))}
            </div>
          )}

          {article.short_summary && (
            <div className="mt-4">
              <p className="text-gray-600 text-sm">{article.short_summary}</p>
            </div>
          )}
        </div>
      );
    }

    function Articles() {
      const [articles, setArticles] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        fetch(`${API_BASE}/api/articles`)
          .then(r => r.json())
          .then(data => {
            setArticles(data.articles);
            setLoading(false);
          })
          .catch(console.error);
      }, []);

      if (loading) return <div className="text-center py-12">Loading...</div>;

      return (
        <div>
          <h2 className="text-2xl font-bold text-gray-800 mb-6">All Articles</h2>
          <div className="space-y-4">
            {articles.map(article => (
              <div key={article.id} className="bg-white rounded-xl shadow-sm p-6 card-hover transition">
                <div className="flex justify-between items-start">
                  <div className="flex-1">
                    <a 
                      href={article.url} 
                      target="_blank" 
                      rel="noopener noreferrer"
                      className="text-lg font-semibold text-gray-800 hover:text-purple-600 transition"
                    >
                      {article.title}
                    </a>
                    <div className="flex items-center space-x-3 mt-2 text-sm text-gray-500">
                      {article.source_name && <span>üì° {article.source_name}</span>}
                    </div>
                  </div>
                  {article.relevance_score && (
                    <div className={`px-3 py-1 rounded-full text-sm font-medium ${
                      article.relevance_score >= 8 ? 'bg-green-100 text-green-800' :
                      article.relevance_score >= 5 ? 'bg-yellow-100 text-yellow-800' :
                      'bg-gray-100 text-gray-800'
                    }`}>
                      Score: {article.relevance_score}/10
                    </div>
                  )}
                </div>

                {article.short_summary && (
                  <p className="text-gray-600 text-sm mt-3">{article.short_summary}</p>
                )}

                <div className="flex flex-wrap gap-2 mt-3">
                  {article.topic_tags?.map(tag => (
                    <span key={tag} className="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs">
                      {tag}
                    </span>
                  ))}
                </div>

                <div className="mt-4 pt-4 border-t border-gray-100 grid grid-cols-3 gap-4 text-sm">
                  <div>
                    <span className="text-gray-500">Organizations:</span>
                    <div className="flex flex-wrap gap-1 mt-1">
                      {article.organizations?.filter(Boolean).map(org => (
                        <span key={org} className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs">
                          {org}
                        </span>
                      ))}
                    </div>
                  </div>
                  <div>
                    <span className="text-gray-500">Technologies:</span>
                    <div className="flex flex-wrap gap-1 mt-1">
                      {article.technologies?.filter(Boolean).map(tech => (
                        <span key={tech} className="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs">
                          {tech}
                        </span>
                      ))}
                    </div>
                  </div>
                  <div>
                    <span className="text-gray-500">People:</span>
                    <div className="flex flex-wrap gap-1 mt-1">
                      {article.people?.filter(Boolean).map(person => (
                        <span key={person} className="bg-orange-100 text-orange-700 px-2 py-0.5 rounded text-xs">
                          {person}
                        </span>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    function Sources() {
      const [sources, setSources] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showForm, setShowForm] = useState(false);
      const [newSource, setNewSource] = useState({ name: '', url: '', sourceType: 'rss', priority: 5 });

      const fetchSources = () => {
        fetch(`${API_BASE}/api/sources`)
          .then(r => r.json())
          .then(data => {
            setSources(data.sources);
            setLoading(false);
          })
          .catch(console.error);
      };

      useEffect(() => { fetchSources(); }, []);

      const addSource = async () => {
        await fetch(`${API_BASE}/api/sources`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newSource)
        });
        setShowForm(false);
        setNewSource({ name: '', url: '', sourceType: 'rss', priority: 5 });
        fetchSources();
      };

      const toggleSource = async (source) => {
        await fetch(`${API_BASE}/api/sources/${source.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled: !source.enabled })
        });
        fetchSources();
      };

      const deleteSource = async (id) => {
        if (confirm('Are you sure you want to delete this source?')) {
          await fetch(`${API_BASE}/api/sources/${id}`, { method: 'DELETE' });
          fetchSources();
        }
      };

      if (loading) return <div className="text-center py-12">Loading...</div>;

      return (
        <div>
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-2xl font-bold text-gray-800">News Sources</h2>
            <button
              onClick={() => setShowForm(!showForm)}
              className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700"
            >
              + Add Source
            </button>
          </div>

          {showForm && (
            <div className="bg-white rounded-xl shadow-sm p-6 mb-6">
              <h3 className="font-semibold mb-4">Add New Source</h3>
              <div className="grid grid-cols-2 gap-4">
                <input
                  type="text"
                  placeholder="Source Name"
                  value={newSource.name}
                  onChange={e => setNewSource({...newSource, name: e.target.value})}
                  className="border rounded-lg px-4 py-2"
                />
                <input
                  type="url"
                  placeholder="URL (RSS feed or website)"
                  value={newSource.url}
                  onChange={e => setNewSource({...newSource, url: e.target.value})}
                  className="border rounded-lg px-4 py-2"
                />
                <select
                  value={newSource.sourceType}
                  onChange={e => setNewSource({...newSource, sourceType: e.target.value})}
                  className="border rounded-lg px-4 py-2"
                >
                  <option value="rss">RSS Feed</option>
                  <option value="scrape">Website (Scrape)</option>
                  <option value="sitemap">Sitemap</option>
                </select>
                <input
                  type="number"
                  placeholder="Priority (1-10)"
                  value={newSource.priority}
                  onChange={e => setNewSource({...newSource, priority: parseInt(e.target.value)})}
                  className="border rounded-lg px-4 py-2"
                  min="1"
                  max="10"
                />
              </div>
              <div className="flex justify-end mt-4 space-x-2">
                <button onClick={() => setShowForm(false)} className="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                <button onClick={addSource} className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Add Source</button>
              </div>
            </div>
          )}

          <div className="space-y-4">
            {sources.map(source => (
              <div key={source.id} className="bg-white rounded-xl shadow-sm p-6 card-hover transition">
                <div className="flex justify-between items-center">
                  <div className="flex-1">
                    <div className="flex items-center space-x-3">
                      <span className={`w-3 h-3 rounded-full ${source.enabled ? 'bg-green-500' : 'bg-gray-300'}`}></span>
                      <h3 className="font-semibold text-gray-800">{source.name}</h3>
                      <span className="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-xs uppercase">
                        {source.source_type || 'rss'}
                      </span>
                    </div>
                    <a href={source.url} target="_blank" className="text-sm text-gray-500 hover:text-purple-600 mt-1 block truncate max-w-xl">
                      {source.url}
                    </a>
                  </div>
                  <div className="flex items-center space-x-4">
                    <span className="text-sm text-gray-500">{source.article_count} articles</span>
                    <button
                      onClick={() => toggleSource(source)}
                      className={`px-3 py-1 rounded text-sm ${source.enabled ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}`}
                    >
                      {source.enabled ? 'Enabled' : 'Disabled'}
                    </button>
                    <button
                      onClick={() => deleteSource(source.id)}
                      className="text-red-500 hover:text-red-700"
                    >
                      üóëÔ∏è
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    function Entities() {
      const [tab, setTab] = useState('organizations');
      const [data, setData] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        setLoading(true);
        fetch(`${API_BASE}/api/entities/${tab}`)
          .then(r => r.json())
          .then(d => {
            setData(d[tab] || []);
            setLoading(false);
          })
          .catch(console.error);
      }, [tab]);

      return (
        <div>
          <h2 className="text-2xl font-bold text-gray-800 mb-6">Entity Browser</h2>

          <div className="flex space-x-2 mb-6">
            {['organizations', 'technologies', 'people'].map(t => (
              <button
                key={t}
                onClick={() => setTab(t)}
                className={`px-4 py-2 rounded-lg transition ${
                  tab === t ? 'bg-purple-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'
                }`}
              >
                {t.charAt(0).toUpperCase() + t.slice(1)}
              </button>
            ))}
          </div>

          {loading ? (
            <div className="text-center py-12">Loading...</div>
          ) : (
            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                    {tab === 'organizations' && <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>}
                    {tab === 'technologies' && <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>}
                    {tab === 'people' && <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th>}
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Articles</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                  {data.map((item, i) => (
                    <tr key={i} className="hover:bg-gray-50">
                      <td className="px-6 py-4 font-medium text-gray-800">
                        {item.canonical_name || item.name}
                      </td>
                      <td className="px-6 py-4 text-gray-600">
                        {tab === 'organizations' && (
                          <span className="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs">
                            {item.type || 'N/A'}
                          </span>
                        )}
                        {tab === 'technologies' && (
                          <span className="bg-green-100 text-green-700 px-2 py-1 rounded text-xs">
                            {item.category || 'N/A'}
                          </span>
                        )}
                        {tab === 'people' && (item.title || item.organization_name || 'N/A')}
                      </td>
                      <td className="px-6 py-4 text-gray-600">{item.article_count}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      );
    }

    function Docs() {
      const [files, setFiles] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        fetch(`${API_BASE}/api/source-files`)
          .then(r => r.json())
          .then(data => {
            setFiles(data.files);
            setLoading(false);
          })
          .catch(console.error);
      }, []);

      const downloadFile = (filename) => {
        window.open(`${API_BASE}/api/source-files/${filename}`, '_blank');
      };

      const downloadAll = async () => {
        for (const file of files) {
          await new Promise(resolve => setTimeout(resolve, 200));
          downloadFile(file.name);
        }
      };

      if (loading) return <div className="text-center py-12">Loading...</div>;

      return (
        <div>
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-2xl font-bold text-gray-800">Agent Documentation</h2>
            <button
              onClick={downloadAll}
              className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center space-x-2"
            >
              <span>üì¶</span>
              <span>Download All</span>
            </button>
          </div>

          <p className="text-gray-600 mb-6">
            These are the core source files that define how the TWH Intelligence Agent works. 
            Download them to understand the filtering logic, entity extraction, and AI processing.
          </p>

          <div className="grid gap-4">
            {files.map(file => (
              <div key={file.name} className="bg-white rounded-xl shadow-sm p-6 card-hover transition flex justify-between items-center">
                <div>
                  <h3 className="font-semibold text-gray-800 flex items-center space-x-2">
                    <span className="text-purple-500">üìÑ</span>
                    <span>{file.name}</span>
                  </h3>
                  <p className="text-sm text-gray-500 mt-1">{file.description}</p>
                  <p className="text-xs text-gray-400 mt-1 font-mono">{file.path}</p>
                </div>
                <button
                  onClick={() => downloadFile(file.name)}
                  className="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg flex items-center space-x-2"
                >
                  <span>‚¨áÔ∏è</span>
                  <span>Download</span>
                </button>
              </div>
            ))}
          </div>

          <div className="mt-8 bg-purple-50 rounded-xl p-6">
            <h3 className="font-semibold text-purple-800 mb-3">How It Works</h3>
            <ul className="text-sm text-purple-700 space-y-2">
              <li><strong>1. Load Sources:</strong> Reads enabled news sources from the database</li>
              <li><strong>2. Monitor Sources:</strong> Scrapes RSS feeds and websites for new articles</li>
              <li><strong>3. Filter Content:</strong> Deduplicates using content hashing to avoid processing the same article twice</li>
              <li><strong>4. Process Articles:</strong> AI extracts entities (organizations, people, technologies) and generates summaries with relevance scores (1-10)</li>
              <li><strong>5. Store Results:</strong> Saves everything to PostgreSQL for querying and analysis</li>
            </ul>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
